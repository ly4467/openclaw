import { j as jsxRuntimeExports, r as reactExports } from "../_chunks/_libs/react.mjs";
import { d as useNavigate, L as Link } from "../_chunks/_libs/@tanstack/react-router.mjs";
import { t as Route, c as useAuthStatus, i as isModerator, u as useQuery, a as api, b as useMutation, k as useAction, s as canManageSkill, j as getSkillBadges, C as ClientOnly } from "./router-yCxIimTd.mjs";
import { L as Le, w as we } from "../_chunks/_libs/@monaco-editor/react.mjs";
import { s as semver } from "../_libs/semver.mjs";
import { M as Markdown } from "../_libs/react-markdown.mjs";
import { r as remarkGfm } from "../_libs/remark-gfm.mjs";
import "../_libs/tiny-warning.mjs";
import "../_chunks/_libs/@tanstack/router-core.mjs";
import "../_chunks/_libs/@tanstack/history.mjs";
import "../_libs/tiny-invariant.mjs";
import "node:stream/web";
import "node:stream";
import "../_libs/react-dom.mjs";
import "../_libs/isbot.mjs";
import "../_chunks/_libs/@vercel/analytics.mjs";
import "../_chunks/_libs/@radix-ui/react-dropdown-menu.mjs";
import "../_chunks/_libs/@radix-ui/primitive.mjs";
import "../_chunks/_libs/@radix-ui/react-compose-refs.mjs";
import "../_chunks/_libs/@radix-ui/react-context.mjs";
import "../_chunks/_libs/@radix-ui/react-use-controllable-state.mjs";
import "../_chunks/_libs/@radix-ui/react-use-layout-effect.mjs";
import "../_chunks/_libs/@radix-ui/react-primitive.mjs";
import "../_chunks/_libs/@radix-ui/react-slot.mjs";
import "../_chunks/_libs/@radix-ui/react-menu.mjs";
import "../_chunks/_libs/@radix-ui/react-collection.mjs";
import "../_chunks/_libs/@radix-ui/react-direction.mjs";
import "../_chunks/_libs/@radix-ui/react-dismissable-layer.mjs";
import "../_chunks/_libs/@radix-ui/react-use-callback-ref.mjs";
import "../_chunks/_libs/@radix-ui/react-use-escape-keydown.mjs";
import "../_chunks/_libs/@radix-ui/react-focus-guards.mjs";
import "../_chunks/_libs/@radix-ui/react-focus-scope.mjs";
import "../_chunks/_libs/@radix-ui/react-popper.mjs";
import "../_chunks/_libs/@floating-ui/react-dom.mjs";
import "../_chunks/_libs/@floating-ui/dom.mjs";
import "../_chunks/_libs/@floating-ui/core.mjs";
import "../_chunks/_libs/@floating-ui/utils.mjs";
import "../_chunks/_libs/@radix-ui/react-arrow.mjs";
import "../_chunks/_libs/@radix-ui/react-use-size.mjs";
import "../_chunks/_libs/@radix-ui/react-portal.mjs";
import "../_chunks/_libs/@radix-ui/react-presence.mjs";
import "../_chunks/_libs/@radix-ui/react-roving-focus.mjs";
import "../_chunks/_libs/@radix-ui/react-id.mjs";
import "../_libs/aria-hidden.mjs";
import "../_libs/react-remove-scroll.mjs";
import "../_libs/tslib.mjs";
import "../_libs/react-remove-scroll-bar.mjs";
import "../_libs/react-style-singleton.mjs";
import "../_libs/get-nonce.mjs";
import "../_libs/use-sidecar.mjs";
import "../_libs/use-callback-ref.mjs";
import "../_libs/clsx.mjs";
import "../_libs/tailwind-merge.mjs";
import "../_chunks/_libs/@radix-ui/react-toggle-group.mjs";
import "../_chunks/_libs/@radix-ui/react-toggle.mjs";
import "../_libs/fflate.mjs";
import "module";
import "../_libs/convex-helpers.mjs";
import "../_libs/convex.mjs";
import "../_libs/lucide-react.mjs";
import "../_chunks/_libs/@monaco-editor/loader.mjs";
import "../_libs/state-local.mjs";
import "../_libs/devlop.mjs";
import "../_libs/unified.mjs";
import "../_libs/bail.mjs";
import "../_libs/extend.mjs";
import "../_libs/is-plain-obj.mjs";
import "../_libs/trough.mjs";
import "../_libs/vfile.mjs";
import "../_libs/vfile-message.mjs";
import "../_libs/unist-util-stringify-position.mjs";
import "node:process";
import "node:path";
import "node:url";
import "../_libs/remark-parse.mjs";
import "../_libs/mdast-util-from-markdown.mjs";
import "../_libs/_CsVBVMCu.mjs";
import "../_libs/micromark-util-decode-string.mjs";
import "../_libs/_vrBDkZ3q.mjs";
import "../_libs/character-entities.mjs";
import "../_libs/_CuJVDrso.mjs";
import "../_libs/micromark.mjs";
import "../_libs/_DLD8nrUX.mjs";
import "../_libs/micromark-util-chunked.mjs";
import "../_libs/micromark-factory-space.mjs";
import "../_libs/micromark-util-character.mjs";
import "../_libs/micromark-core-commonmark.mjs";
import "../_libs/_B_D99lZj.mjs";
import "../_libs/micromark-util-resolve-all.mjs";
import "../_libs/micromark-util-subtokenize.mjs";
import "../_libs/micromark-factory-destination.mjs";
import "../_libs/micromark-factory-label.mjs";
import "../_libs/micromark-factory-title.mjs";
import "../_libs/micromark-factory-whitespace.mjs";
import "../_libs/micromark-util-html-tag-name.mjs";
import "../_libs/mdast-util-to-string.mjs";
import "../_libs/remark-rehype.mjs";
import "../_libs/mdast-util-to-hast.mjs";
import "../_chunks/_libs/@ungap/structured-clone.mjs";
import "../_libs/micromark-util-sanitize-uri.mjs";
import "../_libs/unist-util-position.mjs";
import "../_libs/trim-lines.mjs";
import "../_libs/unist-util-visit.mjs";
import "../_libs/unist-util-visit-parents.mjs";
import "../_libs/unist-util-is.mjs";
import "../_libs/hast-util-to-jsx-runtime.mjs";
import "../_libs/comma-separated-tokens.mjs";
import "../_libs/property-information.mjs";
import "../_libs/space-separated-tokens.mjs";
import "../_libs/style-to-js.mjs";
import "../_libs/style-to-object.mjs";
import "../_libs/inline-style-parser.mjs";
import "../_libs/hast-util-whitespace.mjs";
import "../_libs/estree-util-is-identifier-name.mjs";
import "../_libs/html-url-attributes.mjs";
import "../_libs/micromark-extension-gfm.mjs";
import "../_libs/_BtR1BC-4.mjs";
import "../_libs/_C5wlOzO8.mjs";
import "../_libs/_kK7t0GEl.mjs";
import "../_libs/micromark-extension-gfm-table.mjs";
import "../_libs/_Dcm35_vt.mjs";
import "../_libs/mdast-util-gfm.mjs";
import "../_libs/_CGZt_rLB.mjs";
import "../_libs/ccount.mjs";
import "../_libs/mdast-util-find-and-replace.mjs";
import "../_libs/escape-string-regexp.mjs";
import "../_libs/mdast-util-gfm-footnote.mjs";
import "../_libs/mdast-util-gfm-strikethrough.mjs";
import "../_libs/mdast-util-gfm-table.mjs";
import "../_libs/markdown-table.mjs";
import "../_libs/mdast-util-to-markdown.mjs";
import "../_libs/longest-streak.mjs";
import "../_libs/mdast-util-phrasing.mjs";
import "../_libs/mdast-util-gfm-task-list-item.mjs";
const MAX_DIFF_FILE_BYTES = 200 * 1024;
function sortVersionsBySemver(versions) {
  return [...versions].sort((a, b) => {
    const aValid = Boolean(semver.valid(a.version));
    const bValid = Boolean(semver.valid(b.version));
    if (aValid && bValid) return semver.rcompare(a.version, b.version);
    if (aValid) return -1;
    if (bValid) return 1;
    return a.version.localeCompare(b.version);
  });
}
function resolveLatestVersionId(versions, tags) {
  if (tags?.latest) return tags.latest;
  return sortVersionsBySemver(versions)[0]?.id ?? null;
}
function resolvePreviousVersionId(versions, latestId) {
  const ordered = sortVersionsBySemver(versions);
  if (!latestId) return ordered[1]?.id ?? null;
  const latestIndex = ordered.findIndex((entry) => entry.id === latestId);
  if (latestIndex === -1) return ordered[1]?.id ?? null;
  return ordered[latestIndex + 1]?.id ?? null;
}
function getDefaultDiffSelection(versions, tags) {
  const latestId = resolveLatestVersionId(versions, tags);
  const previousId = resolvePreviousVersionId(versions, latestId);
  return {
    leftId: previousId ?? latestId ?? null,
    rightId: latestId ?? previousId ?? null
  };
}
function buildFileDiffList(leftFiles, rightFiles) {
  const entries = /* @__PURE__ */ new Map();
  for (const file of leftFiles) {
    entries.set(file.path, { left: file });
  }
  for (const file of rightFiles) {
    const existing = entries.get(file.path) ?? {};
    entries.set(file.path, { ...existing, right: file });
  }
  const statusRank = {
    changed: 0,
    added: 1,
    removed: 2,
    same: 3
  };
  return Array.from(entries.entries()).map(([path, info]) => {
    let status = "same";
    if (info.left && !info.right) status = "removed";
    else if (!info.left && info.right) status = "added";
    else if (info.left?.sha256 !== info.right?.sha256) status = "changed";
    return { path, status, left: info.left, right: info.right };
  }).sort((a, b) => {
    const statusDiff = statusRank[a.status] - statusRank[b.status];
    if (statusDiff !== 0) return statusDiff;
    return a.path.localeCompare(b.path);
  });
}
function selectDefaultFilePath(items) {
  const readme = items.find((item) => item.path.toLowerCase() === "skill.md");
  if (readme) return readme.path;
  const changed = items.find((item) => item.status !== "same");
  return changed?.path ?? items[0]?.path ?? null;
}
const EMPTY_DIFF_TEXT = "";
function SkillDiffCard({ skill, versions, variant = "card" }) {
  const getFileText = useAction(api.skills.getFileText);
  const monaco = Le();
  const [viewMode, setViewMode] = reactExports.useState("split");
  const [leftVersionId, setLeftVersionId] = reactExports.useState(null);
  const [rightVersionId, setRightVersionId] = reactExports.useState(null);
  const [selectedPath, setSelectedPath] = reactExports.useState(null);
  const [leftText, setLeftText] = reactExports.useState(EMPTY_DIFF_TEXT);
  const [rightText, setRightText] = reactExports.useState(EMPTY_DIFF_TEXT);
  const [isLoading, setIsLoading] = reactExports.useState(false);
  const [error, setError] = reactExports.useState(null);
  const [sizeWarning, setSizeWarning] = reactExports.useState(null);
  const cacheRef = reactExports.useRef(/* @__PURE__ */ new Map());
  const versionEntries = reactExports.useMemo(
    () => versions.map((entry) => ({ id: entry._id, version: entry.version })),
    [versions]
  );
  const orderedVersions = reactExports.useMemo(() => sortVersionsBySemver(versionEntries), [versionEntries]);
  const versionById = reactExports.useMemo(
    () => new Map(versions.map((entry) => [entry._id, entry])),
    [versions]
  );
  const latestId = reactExports.useMemo(
    () => resolveLatestVersionId(versionEntries, skill.tags),
    [versionEntries, skill.tags]
  );
  const previousId = reactExports.useMemo(
    () => resolvePreviousVersionId(versionEntries, latestId),
    [versionEntries, latestId]
  );
  const versionOptions = reactExports.useMemo(() => {
    const options = [];
    if (latestId) {
      const version = versionById.get(latestId)?.version;
      options.push({
        value: latestId,
        label: version ? `latest (v${version})` : "latest",
        group: "Special"
      });
    }
    if (previousId) {
      const version = versionById.get(previousId)?.version;
      options.push({
        value: previousId,
        label: version ? `previous (v${version})` : "previous",
        group: "Special"
      });
    } else if (versions.length > 0) {
      options.push({
        value: versions[0]._id,
        label: "previous (unavailable)",
        group: "Special",
        disabled: true
      });
    }
    const tagEntries = Object.entries(skill.tags ?? {}).filter(([tag]) => tag !== "latest").sort(([a], [b]) => a.localeCompare(b));
    for (const [tag, versionId] of tagEntries) {
      const version = versionById.get(versionId)?.version;
      options.push({
        value: versionId,
        label: version ? `tag: ${tag} (v${version})` : `tag: ${tag}`,
        group: "Tags",
        disabled: !versionById.has(versionId)
      });
    }
    for (const entry of orderedVersions) {
      options.push({
        value: entry.id,
        label: `v${entry.version}`,
        group: "Versions"
      });
    }
    return options;
  }, [latestId, previousId, orderedVersions, skill.tags, versionById, versions]);
  reactExports.useEffect(() => {
    if (!versions.length) return;
    const defaults = getDefaultDiffSelection(versionEntries, skill.tags);
    setLeftVersionId((current) => {
      if (current && versionById.has(current)) return current;
      return defaults.leftId ? defaults.leftId : null;
    });
    setRightVersionId((current) => {
      if (current && versionById.has(current)) return current;
      return defaults.rightId ? defaults.rightId : null;
    });
  }, [versionEntries, skill.tags, versionById, versions.length]);
  const leftVersion = leftVersionId ? versionById.get(leftVersionId) ?? null : null;
  const rightVersion = rightVersionId ? versionById.get(rightVersionId) ?? null : null;
  const fileDiffItems = reactExports.useMemo(() => {
    return buildFileDiffList(leftVersion?.files ?? [], rightVersion?.files ?? []);
  }, [leftVersion, rightVersion]);
  reactExports.useEffect(() => {
    if (!fileDiffItems.length) {
      setSelectedPath(null);
      return;
    }
    setSelectedPath((current) => {
      if (current && fileDiffItems.some((item) => item.path === current)) return current;
      return selectDefaultFilePath(fileDiffItems);
    });
  }, [fileDiffItems]);
  const selectedItem = reactExports.useMemo(
    () => fileDiffItems.find((item) => item.path === selectedPath) ?? null,
    [fileDiffItems, selectedPath]
  );
  reactExports.useEffect(() => {
    let cancelled = false;
    async function loadText(versionId, path) {
      const cacheKey = `${versionId}:${path}`;
      const cached = cacheRef.current.get(cacheKey);
      if (cached !== void 0) return cached;
      const result = await getFileText({ versionId, path });
      cacheRef.current.set(cacheKey, result.text);
      return result.text;
    }
    async function load() {
      if (!selectedItem || !leftVersionId || !rightVersionId) {
        setLeftText(EMPTY_DIFF_TEXT);
        setRightText(EMPTY_DIFF_TEXT);
        return;
      }
      setIsLoading(true);
      setError(null);
      setSizeWarning(null);
      const leftFile = selectedItem.left;
      const rightFile = selectedItem.right;
      const warnings = [];
      if (leftFile && leftFile.size > MAX_DIFF_FILE_BYTES) {
        warnings.push({ side: "left", path: leftFile.path });
      }
      if (rightFile && rightFile.size > MAX_DIFF_FILE_BYTES) {
        warnings.push({ side: "right", path: rightFile.path });
      }
      if (warnings.length) {
        if (!cancelled) {
          setSizeWarning(warnings[0]);
          setLeftText(EMPTY_DIFF_TEXT);
          setRightText(EMPTY_DIFF_TEXT);
          setIsLoading(false);
        }
        return;
      }
      try {
        const [nextLeft, nextRight] = await Promise.all([
          leftFile ? loadText(leftVersionId, leftFile.path) : Promise.resolve(""),
          rightFile ? loadText(rightVersionId, rightFile.path) : Promise.resolve("")
        ]);
        if (cancelled) return;
        setLeftText(nextLeft ?? EMPTY_DIFF_TEXT);
        setRightText(nextRight ?? EMPTY_DIFF_TEXT);
      } catch (err) {
        if (cancelled) return;
        setError(err instanceof Error ? err.message : "Failed to load diff");
      } finally {
        if (!cancelled) setIsLoading(false);
      }
    }
    void load();
    return () => {
      cancelled = true;
    };
  }, [getFileText, leftVersionId, rightVersionId, selectedItem]);
  reactExports.useEffect(() => {
    if (!monaco || typeof document === "undefined") return;
    const observer = new MutationObserver(() => {
      applyMonacoTheme(monaco);
    });
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme"]
    });
    applyMonacoTheme(monaco);
    return () => observer.disconnect();
  }, [monaco]);
  const leftLabel = leftVersion ? `v${leftVersion.version}` : "—";
  const rightLabel = rightVersion ? `v${rightVersion.version}` : "—";
  const diffUnavailable = versions.length < 2;
  const selectionReady = Boolean(leftVersionId && rightVersionId);
  const fileSelected = Boolean(selectedItem);
  const containerClass = variant === "card" ? "card diff-card" : "diff-card diff-card-embedded";
  return /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: containerClass, children: [
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-header", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Compare versions" }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", style: { margin: 0 }, children: "Inline or side-by-side diff for any file." })
      ] }),
      /* @__PURE__ */ jsxRuntimeExports.jsxs("fieldset", { className: "diff-toggle-group", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("legend", { className: "sr-only", children: "Diff layout" }),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `diff-toggle${viewMode === "split" ? " is-active" : ""}`,
            type: "button",
            onClick: () => setViewMode("split"),
            children: "Side-by-side"
          }
        ),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `diff-toggle${viewMode === "inline" ? " is-active" : ""}`,
            type: "button",
            onClick: () => setViewMode("inline"),
            children: "Inline"
          }
        )
      ] })
    ] }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-controls", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-select", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("label", { htmlFor: "diff-left", children: "Left" }),
        /* @__PURE__ */ jsxRuntimeExports.jsxs(
          "select",
          {
            id: "diff-left",
            className: "search-input",
            value: leftVersionId ?? "",
            onChange: (event) => setLeftVersionId(event.target.value),
            children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: "", disabled: true, children: "Select version" }),
              renderOptions(versionOptions)
            ]
          }
        )
      ] }),
      /* @__PURE__ */ jsxRuntimeExports.jsx(
        "button",
        {
          className: "btn diff-swap",
          type: "button",
          onClick: () => {
            setLeftVersionId(rightVersionId);
            setRightVersionId(leftVersionId);
          },
          disabled: !leftVersionId || !rightVersionId,
          children: "Swap"
        }
      ),
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-select", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("label", { htmlFor: "diff-right", children: "Right" }),
        /* @__PURE__ */ jsxRuntimeExports.jsxs(
          "select",
          {
            id: "diff-right",
            className: "search-input",
            value: rightVersionId ?? "",
            onChange: (event) => setRightVersionId(event.target.value),
            children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: "", disabled: true, children: "Select version" }),
              renderOptions(versionOptions)
            ]
          }
        )
      ] })
    ] }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-meta", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("span", { children: [
        "Left ",
        leftLabel,
        " • Right ",
        rightLabel
      ] }),
      diffUnavailable ? /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: "Need at least 2 versions." }) : null
    ] }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-layout", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-files", children: fileDiffItems.length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "No files to compare." }) : fileDiffItems.map((item) => /* @__PURE__ */ jsxRuntimeExports.jsxs(
        "button",
        {
          type: "button",
          className: `diff-file${item.path === selectedPath ? " is-active" : ""}`,
          onClick: () => setSelectedPath(item.path),
          children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: `diff-pill diff-pill-${item.status}`, children: item.status }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "diff-file-name", children: item.path })
          ]
        },
        item.path
      )) }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-view", children: error ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: error }) : sizeWarning ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "diff-empty", children: [
        sizeWarning.side === "left" ? "Left" : "Right",
        " file exceeds 200KB:",
        " ",
        sizeWarning.path
      ] }) : diffUnavailable ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "Publish another version to compare." }) : !selectionReady ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "Select two versions to compare." }) : !fileSelected ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "Select a file to compare." }) : /* @__PURE__ */ jsxRuntimeExports.jsxs(ClientOnly, { fallback: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "Preparing diff…" }), children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          we,
          {
            className: "diff-monaco",
            original: leftText,
            modified: rightText,
            theme: getMonacoThemeName(),
            loading: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-empty", children: "Loading diff…" }),
            options: buildDiffOptions(viewMode)
          }
        ),
        isLoading ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "diff-loading", children: "Loading…" }) : null
      ] }) })
    ] })
  ] });
}
function renderOptions(options) {
  const groups = {
    Special: [],
    Tags: [],
    Versions: []
  };
  for (const option of options) {
    groups[option.group].push(option);
  }
  return ["Special", "Tags", "Versions"].filter((group) => groups[group].length > 0).map((group) => /* @__PURE__ */ jsxRuntimeExports.jsx("optgroup", { label: group, children: groups[group].map((option) => /* @__PURE__ */ jsxRuntimeExports.jsx("option", { value: option.value, disabled: option.disabled, children: option.label }, `${group}-${option.value}`)) }, group));
}
function getMonacoThemeName() {
  if (typeof document === "undefined") return "clawhub-light";
  return document.documentElement.dataset.theme === "dark" ? "clawhub-dark" : "clawhub-light";
}
function buildDiffOptions(viewMode) {
  return {
    readOnly: true,
    renderSideBySide: viewMode === "split",
    renderSideBySideInlineBreakpoint: 860,
    wordWrap: "on",
    minimap: { enabled: false },
    scrollBeyondLastLine: false,
    overviewRulerBorder: false,
    renderIndicators: true,
    diffAlgorithm: "advanced",
    fontFamily: "var(--font-mono)",
    fontSize: 13
  };
}
function applyMonacoTheme(monaco) {
  const styles = getComputedStyle(document.documentElement);
  const surface = normalizeHex(styles.getPropertyValue("--surface").trim() || "#ffffff");
  const surfaceMuted = styles.getPropertyValue("--surface-muted").trim() || "#f6f1ec";
  const ink = styles.getPropertyValue("--ink").trim() || "#1d1a17";
  const inkSoft = styles.getPropertyValue("--ink-soft").trim() || "#4c463f";
  const line = styles.getPropertyValue("--line").trim() || "rgba(29, 26, 23, 0.12)";
  const accent = styles.getPropertyValue("--accent").trim() || "#ff6b4a";
  const seafoam = styles.getPropertyValue("--seafoam").trim() || "#2bc6a4";
  const diffAdded = styles.getPropertyValue("--diff-added").trim() || seafoam;
  const diffRemoved = styles.getPropertyValue("--diff-removed").trim() || accent;
  const background = surface;
  const gutter = surfaceMuted;
  const isDark = document.documentElement.dataset.theme === "dark";
  const base = isDark ? "vs-dark" : "vs";
  const diffInserted = toRgba(diffAdded, isDark ? 0.12 : 0.16);
  const diffRemovedBg = toRgba(diffRemoved, isDark ? 0.12 : 0.16);
  monaco.editor.defineTheme(`clawhub-${isDark ? "dark" : "light"}`, {
    base,
    inherit: true,
    rules: [
      { token: "", foreground: normalizeHex(ink) },
      { token: "comment", foreground: normalizeHex(inkSoft) }
    ],
    colors: {
      "editor.background": background,
      "editor.foreground": ink,
      "editorLineNumber.foreground": inkSoft,
      "editorLineNumber.activeForeground": ink,
      "editorGutter.background": gutter,
      "editor.selectionBackground": toRgba(accent, 0.18),
      "editor.inactiveSelectionBackground": toRgba(accent, 0.12),
      "editorWidget.background": surface,
      "editorWidget.border": line,
      "editorWidget.foreground": ink,
      "diffEditor.insertedTextBackground": diffInserted,
      "diffEditor.removedTextBackground": diffRemovedBg,
      "diffEditor.insertedLineBackground": diffInserted,
      "diffEditor.removedLineBackground": diffRemovedBg,
      "diffEditor.border": line,
      "scrollbarSlider.background": toRgba(inkSoft, 0.15),
      "scrollbarSlider.hoverBackground": toRgba(inkSoft, 0.28),
      "scrollbarSlider.activeBackground": toRgba(inkSoft, 0.4)
    }
  });
  monaco.editor.setTheme(`clawhub-${isDark ? "dark" : "light"}`);
}
function normalizeHex(value) {
  if (!value.startsWith("#")) return value;
  if (value.length === 4) {
    return `#${value[1]}${value[1]}${value[2]}${value[2]}${value[3]}${value[3]}`;
  }
  return value;
}
function toRgba(color, alpha) {
  const hex = normalizeHex(color).replace("#", "");
  if (hex.length !== 6) return color;
  const r = Number.parseInt(hex.slice(0, 2), 16);
  const g = Number.parseInt(hex.slice(2, 4), 16);
  const b = Number.parseInt(hex.slice(4, 6), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha})`;
}
function VirusTotalIcon({ className }) {
  return /* @__PURE__ */ jsxRuntimeExports.jsxs(
    "svg",
    {
      className,
      width: "1em",
      height: "1em",
      xmlns: "http://www.w3.org/2000/svg",
      viewBox: "0 0 100 89",
      "aria-label": "VirusTotal",
      children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("title", { children: "VirusTotal" }),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "path",
          {
            fill: "currentColor",
            fillRule: "evenodd",
            d: "M45.292 44.5 0 89h100V0H0l45.292 44.5zM90 80H22l35.987-35.2L22 9h68v71z"
          }
        )
      ]
    }
  );
}
function getScanStatusInfo(status) {
  switch (status.toLowerCase()) {
    case "benign":
    case "clean":
      return { label: "Benign", className: "scan-status-clean" };
    case "malicious":
      return { label: "Malicious", className: "scan-status-malicious" };
    case "suspicious":
      return { label: "Suspicious", className: "scan-status-suspicious" };
    case "loading":
      return { label: "Loading...", className: "scan-status-pending" };
    case "pending":
    case "not_found":
      return { label: "Pending", className: "scan-status-pending" };
    case "error":
    case "failed":
      return { label: "Error", className: "scan-status-error" };
    default:
      return { label: status, className: "scan-status-unknown" };
  }
}
function useSecurityScan(sha256hash, enabled = true) {
  const fetchVT = useAction(api.vt.fetchResults);
  const [result, setResult] = reactExports.useState(null);
  const [loading, setLoading] = reactExports.useState(false);
  reactExports.useEffect(() => {
    if (!sha256hash || !enabled) {
      setResult(null);
      setLoading(false);
      return;
    }
    let cancelled = false;
    setLoading(true);
    void fetchVT({ sha256hash }).then((res) => {
      if (!cancelled) {
        setResult(res);
        setLoading(false);
      }
    }).catch(() => {
      if (!cancelled) {
        setResult({ status: "error" });
        setLoading(false);
      }
    });
    return () => {
      cancelled = true;
    };
  }, [sha256hash, enabled, fetchVT]);
  return { result, loading };
}
function SecurityScanResults({
  sha256hash,
  variant = "panel",
  enabled = true
}) {
  const { result, loading } = useSecurityScan(sha256hash, enabled);
  if (!sha256hash) return null;
  const status = loading ? "loading" : result?.status ?? "pending";
  const url = result?.url;
  const statusInfo = getScanStatusInfo(status);
  const metadata = result?.metadata;
  const isCodeInsight = result?.source === "code_insight";
  const aiAnalysis = metadata?.aiAnalysis;
  const displayLabel = statusInfo.label;
  if (variant === "badge") {
    return /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "version-scan-badge", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx(VirusTotalIcon, { className: "version-scan-icon version-scan-icon-vt" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: statusInfo.className, children: displayLabel }),
      url ? /* @__PURE__ */ jsxRuntimeExports.jsx(
        "a",
        {
          href: url,
          target: "_blank",
          rel: "noopener noreferrer",
          className: "version-scan-link",
          onClick: (e) => e.stopPropagation(),
          children: "↗"
        }
      ) : null
    ] });
  }
  return /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "scan-results-panel", children: [
    /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "scan-results-title", children: "Security Scan" }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "scan-results-list", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "scan-result-row", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "scan-result-scanner", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx(VirusTotalIcon, { className: "scan-result-icon scan-result-icon-vt" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "scan-result-scanner-name", children: "VirusTotal" })
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: `scan-result-status ${statusInfo.className}`, children: displayLabel }),
        url ? /* @__PURE__ */ jsxRuntimeExports.jsx("a", { href: url, target: "_blank", rel: "noopener noreferrer", className: "scan-result-link", children: "View report →" }) : null
      ] }),
      isCodeInsight && aiAnalysis && (status === "malicious" || status === "suspicious") ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "code-insight-analysis", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "code-insight-label", children: "Code Insight" }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "code-insight-text", children: aiAnalysis })
      ] }) : null
    ] })
  ] });
}
function formatReportError(error) {
  if (error && typeof error === "object" && "data" in error) {
    const data = error.data;
    if (typeof data === "string" && data.trim()) return data.trim();
    if (data && typeof data === "object" && "message" in data && typeof data.message === "string") {
      const message = data.message?.trim();
      if (message) return message;
    }
  }
  if (error instanceof Error) {
    const cleaned = error.message.replace(/\[CONVEX[^\]]*\]\s*/g, "").replace(/\[Request ID:[^\]]*\]\s*/g, "").replace(/^Server Error Called by client\s*/i, "").replace(/^ConvexError:\s*/i, "").trim();
    if (cleaned && cleaned !== "Server Error") return cleaned;
  }
  return "Unable to submit report. Please try again.";
}
function SkillDetailPage({
  slug,
  canonicalOwner,
  redirectToCanonical
}) {
  const navigate = useNavigate();
  const { isAuthenticated, me } = useAuthStatus();
  const isStaff = isModerator(me);
  const staffResult = useQuery(api.skills.getBySlugForStaff, isStaff ? { slug } : "skip");
  const publicResult = useQuery(api.skills.getBySlug, !isStaff ? { slug } : "skip");
  const result = isStaff ? staffResult : publicResult;
  const toggleStar = useMutation(api.stars.toggle);
  const reportSkill = useMutation(api.skills.report);
  const addComment = useMutation(api.comments.add);
  const removeComment = useMutation(api.comments.remove);
  const updateTags = useMutation(api.skills.updateTags);
  const getReadme = useAction(api.skills.getReadme);
  const [readme, setReadme] = reactExports.useState(null);
  const [readmeError, setReadmeError] = reactExports.useState(null);
  const [comment, setComment] = reactExports.useState("");
  const [tagName, setTagName] = reactExports.useState("latest");
  const [tagVersionId, setTagVersionId] = reactExports.useState("");
  const [activeTab, setActiveTab] = reactExports.useState("files");
  const [versionScanOpen, setVersionScanOpen] = reactExports.useState({});
  const isLoadingSkill = result === void 0;
  const skill = result?.skill;
  const owner = result?.owner;
  const latestVersion = result?.latestVersion;
  const versions = useQuery(
    api.skills.listVersions,
    skill ? { skillId: skill._id, limit: 50 } : "skip"
  );
  const diffVersions = useQuery(
    api.skills.listVersions,
    skill ? { skillId: skill._id, limit: 200 } : "skip"
  );
  const isStarred = useQuery(
    api.stars.isStarred,
    isAuthenticated && skill ? { skillId: skill._id } : "skip"
  );
  const comments = useQuery(
    api.comments.listBySkill,
    skill ? { skillId: skill._id, limit: 50 } : "skip"
  );
  const canManage = canManageSkill(me, skill);
  const ownerHandle = owner?.handle ?? owner?.name ?? null;
  const ownerParam = ownerHandle ?? (owner?._id ? String(owner._id) : null);
  const wantsCanonicalRedirect = Boolean(
    ownerParam && (redirectToCanonical || typeof canonicalOwner === "string" && canonicalOwner && canonicalOwner !== ownerParam)
  );
  const forkOf = result?.forkOf ?? null;
  const canonical = result?.canonical ?? null;
  const modInfo = result?.moderationInfo ?? null;
  const forkOfLabel = forkOf?.kind === "duplicate" ? "duplicate of" : "fork of";
  const forkOfOwnerHandle = forkOf?.owner?.handle ?? null;
  const forkOfOwnerId = forkOf?.owner?.userId ?? null;
  const canonicalOwnerHandle = canonical?.owner?.handle ?? null;
  const canonicalOwnerId = canonical?.owner?.userId ?? null;
  const forkOfHref = forkOf?.skill?.slug ? buildSkillHref(forkOfOwnerHandle, forkOfOwnerId, forkOf.skill.slug) : null;
  const canonicalHref = canonical?.skill?.slug && canonical.skill.slug !== forkOf?.skill?.slug ? buildSkillHref(canonicalOwnerHandle, canonicalOwnerId, canonical.skill.slug) : null;
  const staffSkill = isStaff && skill ? skill : null;
  const moderationStatus = staffSkill?.moderationStatus ?? (staffSkill?.softDeletedAt ? "hidden" : void 0);
  const isHidden = moderationStatus === "hidden" || Boolean(staffSkill?.softDeletedAt);
  const isRemoved = moderationStatus === "removed";
  const isAutoHidden = isHidden && staffSkill?.moderationReason === "auto.reports";
  const staffVisibilityTag = isRemoved ? "Removed" : isAutoHidden ? "Auto-hidden" : isHidden ? "Hidden" : null;
  const staffModerationNote = staffVisibilityTag ? isAutoHidden ? "Auto-hidden after 4+ unique reports." : isRemoved ? "Removed from public view." : "Hidden from public view." : null;
  reactExports.useEffect(() => {
    if (!wantsCanonicalRedirect || !ownerParam) return;
    void navigate({
      to: "/$owner/$slug",
      params: { owner: ownerParam, slug },
      replace: true
    });
  }, [navigate, ownerParam, slug, wantsCanonicalRedirect]);
  const versionById = new Map(
    (diffVersions ?? versions ?? []).map((version) => [version._id, version])
  );
  const clawdis = latestVersion?.parsed?.clawdis;
  const osLabels = reactExports.useMemo(() => formatOsList(clawdis?.os), [clawdis?.os]);
  const requirements = clawdis?.requires;
  const installSpecs = clawdis?.install ?? [];
  const nixPlugin = clawdis?.nix?.plugin;
  const nixSystems = clawdis?.nix?.systems ?? [];
  const nixSnippet = nixPlugin ? formatNixInstallSnippet(nixPlugin) : null;
  const configRequirements = clawdis?.config;
  const configExample = configRequirements?.example ? formatConfigSnippet(configRequirements.example) : null;
  const cliHelp = clawdis?.cliHelp;
  const hasRuntimeRequirements = Boolean(
    clawdis?.emoji || osLabels.length || requirements?.bins?.length || requirements?.anyBins?.length || requirements?.env?.length || requirements?.config?.length || clawdis?.primaryEnv
  );
  const hasInstallSpecs = installSpecs.length > 0;
  const hasPluginBundle = Boolean(nixSnippet || configRequirements || cliHelp);
  const readmeContent = reactExports.useMemo(() => {
    if (!readme) return null;
    return stripFrontmatter(readme);
  }, [readme]);
  const latestFiles = latestVersion?.files ?? [];
  reactExports.useEffect(() => {
    if (!latestVersion) return;
    setReadme(null);
    setReadmeError(null);
    let cancelled = false;
    void getReadme({ versionId: latestVersion._id }).then((data) => {
      if (cancelled) return;
      setReadme(data.text);
    }).catch((error) => {
      if (cancelled) return;
      setReadmeError(error instanceof Error ? error.message : "Failed to load README");
      setReadme(null);
    });
    return () => {
      cancelled = true;
    };
  }, [latestVersion, getReadme]);
  reactExports.useEffect(() => {
    if (!tagVersionId && latestVersion) {
      setTagVersionId(latestVersion._id);
    }
  }, [latestVersion, tagVersionId]);
  if (isLoadingSkill || wantsCanonicalRedirect) {
    return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "loading-indicator", children: "Loading skill…" }) }) });
  }
  if (result === null || !skill) {
    return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card", children: "Skill not found." }) });
  }
  const tagEntries = Object.entries(skill.tags ?? {});
  return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-detail-stack", children: [
    modInfo?.isPendingScan ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "pending-banner", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "pending-banner-content", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Security scan in progress" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { children: "Your skill is being scanned by VirusTotal. It will be visible to others once the scan completes and passes review." })
    ] }) }) : modInfo?.isMalwareBlocked ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "pending-banner pending-banner-blocked", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "pending-banner-content", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Skill blocked — security issue detected" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { children: "VirusTotal flagged this skill as potentially malicious. It is not visible to others and downloads are disabled. Review the scan results below." })
    ] }) }) : modInfo?.isRemoved ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "pending-banner pending-banner-blocked", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "pending-banner-content", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Skill removed by moderator" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { children: "This skill has been removed and is not visible to others." })
    ] }) }) : modInfo?.isHiddenByMod ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "pending-banner pending-banner-blocked", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "pending-banner-content", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Skill hidden" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { children: "This skill is currently hidden and not visible to others." })
    ] }) }) : null,
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card skill-hero", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: `skill-hero-top${hasPluginBundle ? " has-plugin" : ""}`, children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-header", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-title", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-title-row", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("h1", { className: "section-title", style: { margin: 0 }, children: skill.displayName }),
              nixPlugin ? /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "tag tag-accent", children: "Plugin bundle (nix)" }) : null
            ] }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", children: skill.summary ?? "No summary provided." }),
            isStaff && staffModerationNote ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-hero-note", children: staffModerationNote }) : null,
            nixPlugin ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-hero-note", children: "Bundles the skill pack, CLI binary, and config requirements in one Nix install." }) : null,
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              "⭐ ",
              skill.stats.stars,
              " · ⤓ ",
              skill.stats.downloads,
              " · ⤒",
              " ",
              skill.stats.installsCurrent ?? 0,
              " current · ",
              skill.stats.installsAllTime ?? 0,
              " ",
              "all-time"
            ] }),
            owner?.handle ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              "by ",
              /* @__PURE__ */ jsxRuntimeExports.jsxs("a", { href: `/u/${owner.handle}`, children: [
                "@",
                owner.handle
              ] })
            ] }) : null,
            forkOf && forkOfHref ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              forkOfLabel,
              " ",
              /* @__PURE__ */ jsxRuntimeExports.jsxs("a", { href: forkOfHref, children: [
                forkOfOwnerHandle ? `@${forkOfOwnerHandle}/` : "",
                forkOf.skill.slug
              ] }),
              forkOf.version ? ` (based on ${forkOf.version})` : null
            ] }) : null,
            canonicalHref ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              "canonical:",
              " ",
              /* @__PURE__ */ jsxRuntimeExports.jsxs("a", { href: canonicalHref, children: [
                canonicalOwnerHandle ? `@${canonicalOwnerHandle}/` : "",
                canonical?.skill?.slug
              ] })
            ] }) : null,
            getSkillBadges(skill).map((badge) => /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "tag", children: badge }, badge)),
            isStaff && staffVisibilityTag ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: `tag${isAutoHidden || isRemoved ? " tag-accent" : ""}`, children: staffVisibilityTag }) : null,
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-actions", children: [
              isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsx(
                "button",
                {
                  className: `star-toggle${isStarred ? " is-active" : ""}`,
                  type: "button",
                  onClick: () => void toggleStar({ skillId: skill._id }),
                  "aria-label": isStarred ? "Unstar skill" : "Star skill",
                  children: /* @__PURE__ */ jsxRuntimeExports.jsx("span", { "aria-hidden": "true", children: "★" })
                }
              ) : null,
              isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsx(
                "button",
                {
                  className: "btn btn-ghost",
                  type: "button",
                  onClick: async () => {
                    const reason = window.prompt(
                      "Report this skill? A reason is required. Abuse may result in a ban."
                    );
                    if (reason === null) return;
                    const trimmedReason = reason.trim();
                    if (!trimmedReason) {
                      window.alert("Report reason required.");
                      return;
                    }
                    try {
                      const result2 = await reportSkill({
                        skillId: skill._id,
                        reason: trimmedReason
                      });
                      if (result2.reported) {
                        window.alert("Thanks — your report has been submitted.");
                      } else {
                        window.alert("You have already reported this skill.");
                      }
                    } catch (error) {
                      console.error("Failed to report skill", error);
                      window.alert(formatReportError(error));
                    }
                  },
                  children: "Report"
                }
              ) : null,
              isStaff ? /* @__PURE__ */ jsxRuntimeExports.jsx(Link, { className: "btn", to: "/management", search: { skill: skill.slug }, children: "Manage" }) : null
            ] }),
            isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "section-subtitle", style: { margin: "6px 0 0" }, children: "Reports require a reason. Abuse may result in a ban." }) : null,
            /* @__PURE__ */ jsxRuntimeExports.jsx(SecurityScanResults, { sha256hash: latestVersion?.sha256hash }),
            latestVersion?.sha256hash ? /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "scan-disclaimer", children: "Like a lobster shell, security has layers — review code before you run it." }) : null
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-cta", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-version-pill", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "skill-version-label", children: "Current version" }),
              /* @__PURE__ */ jsxRuntimeExports.jsxs("strong", { children: [
                "v",
                latestVersion?.version ?? "—"
              ] })
            ] }),
            !nixPlugin && !modInfo?.isMalwareBlocked && !modInfo?.isRemoved ? /* @__PURE__ */ jsxRuntimeExports.jsx(
              "a",
              {
                className: "btn btn-primary",
                href: `${void 0}/api/v1/download?slug=${skill.slug}`,
                children: "Download zip"
              }
            ) : null
          ] })
        ] }),
        hasPluginBundle ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-panel bundle-card", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "bundle-header", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "bundle-title", children: "Plugin bundle (nix)" }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "bundle-subtitle", children: "Skill pack · CLI binary · Config" })
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "bundle-includes", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: "SKILL.md" }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: "CLI" }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: "Config" })
          ] }),
          configRequirements ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "bundle-section", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "bundle-section-title", children: "Config requirements" }),
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "bundle-meta", children: [
              configRequirements.requiredEnv?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
                /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Required env" }),
                /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: configRequirements.requiredEnv.join(", ") })
              ] }) : null,
              configRequirements.stateDirs?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
                /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "State dirs" }),
                /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: configRequirements.stateDirs.join(", ") })
              ] }) : null
            ] })
          ] }) : null,
          cliHelp ? /* @__PURE__ */ jsxRuntimeExports.jsxs("details", { className: "bundle-section bundle-details", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("summary", { children: "CLI help (from plugin)" }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("pre", { className: "hero-install-code mono", children: cliHelp })
          ] }) : null
        ] }) : null
      ] }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-tag-row", children: tagEntries.length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "section-subtitle", style: { margin: 0 }, children: "No tags yet." }) : tagEntries.map(([tag, versionId]) => /* @__PURE__ */ jsxRuntimeExports.jsxs("span", { className: "tag", children: [
        tag,
        /* @__PURE__ */ jsxRuntimeExports.jsxs("span", { className: "tag-meta", children: [
          "v",
          versionById.get(versionId)?.version ?? versionId
        ] })
      ] }, tag)) }),
      canManage ? /* @__PURE__ */ jsxRuntimeExports.jsxs(
        "form",
        {
          onSubmit: (event) => {
            event.preventDefault();
            if (!tagName.trim() || !tagVersionId) return;
            void updateTags({
              skillId: skill._id,
              tags: [{ tag: tagName.trim(), versionId: tagVersionId }]
            });
          },
          className: "tag-form",
          children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx(
              "input",
              {
                className: "search-input",
                value: tagName,
                onChange: (event) => setTagName(event.target.value),
                placeholder: "latest"
              }
            ),
            /* @__PURE__ */ jsxRuntimeExports.jsx(
              "select",
              {
                className: "search-input",
                value: tagVersionId ?? "",
                onChange: (event) => setTagVersionId(event.target.value),
                children: (diffVersions ?? []).map((version) => /* @__PURE__ */ jsxRuntimeExports.jsxs("option", { value: version._id, children: [
                  "v",
                  version.version
                ] }, version._id))
              }
            ),
            /* @__PURE__ */ jsxRuntimeExports.jsx("button", { className: "btn", type: "submit", children: "Update tag" })
          ]
        }
      ) : null,
      hasRuntimeRequirements || hasInstallSpecs ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-hero-content", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-panels", children: [
        hasRuntimeRequirements ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-panel", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("h3", { className: "section-title", style: { fontSize: "1rem", margin: 0 }, children: "Runtime requirements" }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-panel-body", children: [
            clawdis?.emoji ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "tag", children: [
              clawdis.emoji,
              " Clawdis"
            ] }) : null,
            osLabels.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "OS" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: osLabels.join(" · ") })
            ] }) : null,
            requirements?.bins?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Bins" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: requirements.bins.join(", ") })
            ] }) : null,
            requirements?.anyBins?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Any bin" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: requirements.anyBins.join(", ") })
            ] }) : null,
            requirements?.env?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Env" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: requirements.env.join(", ") })
            ] }) : null,
            requirements?.config?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Config" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: requirements.config.join(", ") })
            ] }) : null,
            clawdis?.primaryEnv ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: "Primary env" }),
              /* @__PURE__ */ jsxRuntimeExports.jsx("span", { children: clawdis.primaryEnv })
            ] }) : null
          ] })
        ] }) : null,
        hasInstallSpecs ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-panel", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("h3", { className: "section-title", style: { fontSize: "1rem", margin: 0 }, children: "Install" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-panel-body", children: installSpecs.map((spec, index) => {
            const command = formatInstallCommand(spec);
            return /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "stat", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
              /* @__PURE__ */ jsxRuntimeExports.jsx("strong", { children: spec.label ?? formatInstallLabel(spec) }),
              spec.bins?.length ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { style: { color: "var(--ink-soft)", fontSize: "0.85rem" }, children: [
                "Bins: ",
                spec.bins.join(", ")
              ] }) : null,
              command ? /* @__PURE__ */ jsxRuntimeExports.jsx("code", { children: command }) : null
            ] }) }, `${spec.id ?? spec.kind}-${index}`);
          }) })
        ] }) : null
      ] }) }) : null
    ] }),
    nixSnippet ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Install via Nix" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", style: { margin: 0 }, children: nixSystems.length ? `Systems: ${nixSystems.join(", ")}` : "nix-clawdbot" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("pre", { className: "hero-install-code", style: { marginTop: 12 }, children: nixSnippet })
    ] }) : null,
    configExample ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Config example" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", style: { margin: 0 }, children: "Starter config for this plugin bundle." }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("pre", { className: "hero-install-code", style: { marginTop: 12 }, children: configExample })
    ] }) : null,
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card tab-card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "tab-header", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `tab-button${activeTab === "files" ? " is-active" : ""}`,
            type: "button",
            onClick: () => setActiveTab("files"),
            children: "Files"
          }
        ),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `tab-button${activeTab === "compare" ? " is-active" : ""}`,
            type: "button",
            onClick: () => setActiveTab("compare"),
            children: "Compare"
          }
        ),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `tab-button${activeTab === "versions" ? " is-active" : ""}`,
            type: "button",
            onClick: () => setActiveTab("versions"),
            children: "Versions"
          }
        )
      ] }),
      activeTab === "files" ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "tab-body", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "SKILL.md" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "markdown", children: readmeContent ? /* @__PURE__ */ jsxRuntimeExports.jsx(Markdown, { remarkPlugins: [remarkGfm], children: readmeContent }) : readmeError ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
            "Failed to load SKILL.md: ",
            readmeError
          ] }) : /* @__PURE__ */ jsxRuntimeExports.jsx("div", { children: "Loading…" }) })
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "file-list", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "file-list-header", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("h3", { className: "section-title", style: { fontSize: "1.05rem", margin: 0 }, children: "Files" }),
            /* @__PURE__ */ jsxRuntimeExports.jsxs("span", { className: "section-subtitle", style: { margin: 0 }, children: [
              latestFiles.length,
              " total"
            ] })
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "file-list-body", children: latestFiles.length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "stat", children: "No files available." }) : latestFiles.map((file) => /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "file-row", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "file-path", children: file.path }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "file-meta", children: formatBytes(file.size) })
          ] }, file.path)) })
        ] })
      ] }) : null,
      activeTab === "compare" && skill ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "tab-body", children: /* @__PURE__ */ jsxRuntimeExports.jsx(SkillDiffCard, { skill, versions: diffVersions ?? [], variant: "embedded" }) }) : null,
      activeTab === "versions" ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "tab-body", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Versions" }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", style: { margin: 0 }, children: nixPlugin ? "Review release history and changelog." : "Download older releases or scan the changelog." })
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-scroll", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-list", children: (versions ?? []).map((version) => /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "version-row", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "version-info", children: [
            /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
              "v",
              version.version,
              " · ",
              new Date(version.createdAt).toLocaleDateString(),
              version.changelogSource === "auto" ? /* @__PURE__ */ jsxRuntimeExports.jsx("span", { style: { color: "var(--ink-soft)" }, children: " · auto" }) : null
            ] }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { color: "#5c554e", whiteSpace: "pre-wrap" }, children: version.changelog }),
            /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-scan-results", children: version.sha256hash ? versionScanOpen[version._id] ? /* @__PURE__ */ jsxRuntimeExports.jsx(
              SecurityScanResults,
              {
                sha256hash: version.sha256hash,
                variant: "badge",
                enabled: true
              }
            ) : /* @__PURE__ */ jsxRuntimeExports.jsx(
              "button",
              {
                className: "version-scan-toggle",
                type: "button",
                onClick: () => setVersionScanOpen((prev) => ({
                  ...prev,
                  [version._id]: true
                })),
                children: "Load scan"
              }
            ) : null })
          ] }),
          !nixPlugin ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-actions", children: /* @__PURE__ */ jsxRuntimeExports.jsx(
            "a",
            {
              className: "btn version-zip",
              href: `${void 0}/api/v1/download?slug=${skill.slug}&version=${version.version}`,
              children: "Zip"
            }
          ) }) : null
        ] }, version._id)) }) })
      ] }) : null
    ] }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Comments" }),
      isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsxs(
        "form",
        {
          onSubmit: (event) => {
            event.preventDefault();
            if (!comment.trim()) return;
            void addComment({ skillId: skill._id, body: comment.trim() }).then(
              () => setComment("")
            );
          },
          className: "comment-form",
          children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx(
              "textarea",
              {
                className: "comment-input",
                rows: 4,
                value: comment,
                onChange: (event) => setComment(event.target.value),
                placeholder: "Leave a note…"
              }
            ),
            /* @__PURE__ */ jsxRuntimeExports.jsx("button", { className: "btn comment-submit", type: "submit", children: "Post comment" })
          ]
        }
      ) : /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", children: "Sign in to comment." }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { display: "grid", gap: 12, marginTop: 16 }, children: (comments ?? []).length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "stat", children: "No comments yet." }) : (comments ?? []).map((entry) => /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", style: { alignItems: "flex-start" }, children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("strong", { children: [
            "@",
            entry.user?.handle ?? entry.user?.name ?? "user"
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { color: "#5c554e" }, children: entry.comment.body })
        ] }),
        isAuthenticated && me && (me._id === entry.comment.userId || isModerator(me)) ? /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: "btn",
            type: "button",
            onClick: () => void removeComment({ commentId: entry.comment._id }),
            children: "Delete"
          }
        ) : null
      ] }, entry.comment._id)) })
    ] })
  ] }) });
}
function buildSkillHref(ownerHandle, ownerId, slug) {
  const owner = ownerHandle?.trim() || (ownerId ? String(ownerId) : "unknown");
  return `/${owner}/${slug}`;
}
function formatConfigSnippet(raw) {
  const trimmed = raw.trim();
  if (!trimmed || raw.includes("\n")) return raw;
  try {
    const parsed = JSON.parse(raw);
    return JSON.stringify(parsed, null, 2);
  } catch {
  }
  let out = "";
  let indent = 0;
  let inString = false;
  let isEscaped = false;
  const newline = () => {
    out = out.replace(/[ \t]+$/u, "");
    out += `
${" ".repeat(indent * 2)}`;
  };
  for (let i = 0; i < raw.length; i += 1) {
    const ch = raw[i];
    if (inString) {
      out += ch;
      if (isEscaped) {
        isEscaped = false;
      } else if (ch === "\\") {
        isEscaped = true;
      } else if (ch === '"') {
        inString = false;
      }
      continue;
    }
    if (ch === '"') {
      inString = true;
      out += ch;
      continue;
    }
    if (ch === "{" || ch === "[") {
      out += ch;
      indent += 1;
      newline();
      continue;
    }
    if (ch === "}" || ch === "]") {
      indent = Math.max(0, indent - 1);
      newline();
      out += ch;
      continue;
    }
    if (ch === ";" || ch === ",") {
      out += ch;
      newline();
      continue;
    }
    if (ch === "\n" || ch === "\r" || ch === "	") {
      continue;
    }
    if (ch === " ") {
      if (out.endsWith(" ") || out.endsWith("\n")) {
        continue;
      }
      out += " ";
      continue;
    }
    out += ch;
  }
  return out.trim();
}
function stripFrontmatter(content) {
  const normalized = content.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  if (!normalized.startsWith("---")) return content;
  const endIndex = normalized.indexOf("\n---", 3);
  if (endIndex === -1) return content;
  return normalized.slice(endIndex + 4).replace(/^\n+/, "");
}
function formatOsList(os) {
  if (!os?.length) return [];
  return os.map((entry) => {
    const key = entry.trim().toLowerCase();
    if (key === "darwin" || key === "macos" || key === "mac") return "macOS";
    if (key === "linux") return "Linux";
    if (key === "windows" || key === "win32") return "Windows";
    return entry;
  });
}
function formatInstallLabel(spec) {
  if (spec.kind === "brew") return "Homebrew";
  if (spec.kind === "node") return "Node";
  if (spec.kind === "go") return "Go";
  if (spec.kind === "uv") return "uv";
  return "Install";
}
function formatInstallCommand(spec) {
  if (spec.kind === "brew" && spec.formula) {
    if (spec.tap && !spec.formula.includes("/")) {
      return `brew install ${spec.tap}/${spec.formula}`;
    }
    return `brew install ${spec.formula}`;
  }
  if (spec.kind === "node" && spec.package) {
    return `npm i -g ${spec.package}`;
  }
  if (spec.kind === "go" && spec.module) {
    return `go install ${spec.module}`;
  }
  if (spec.kind === "uv" && spec.package) {
    return `uv tool install ${spec.package}`;
  }
  return null;
}
function formatBytes(bytes) {
  if (!Number.isFinite(bytes)) return "—";
  if (bytes < 1024) return `${bytes} B`;
  const units = ["KB", "MB", "GB"];
  let value = bytes / 1024;
  let unitIndex = 0;
  while (value >= 1024 && unitIndex < units.length - 1) {
    value /= 1024;
    unitIndex += 1;
  }
  return `${value.toFixed(value >= 10 ? 0 : 1)} ${units[unitIndex]}`;
}
function formatNixInstallSnippet(plugin) {
  const snippet = `programs.clawdbot.plugins = [ { source = "${plugin}"; } ];`;
  return formatConfigSnippet(snippet);
}
function OwnerSkill() {
  const {
    owner,
    slug
  } = Route.useParams();
  return /* @__PURE__ */ jsxRuntimeExports.jsx(SkillDetailPage, { slug, canonicalOwner: owner });
}
export {
  OwnerSkill as component
};
