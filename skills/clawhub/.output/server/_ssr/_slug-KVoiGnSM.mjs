import { j as jsxRuntimeExports, r as reactExports } from "../_chunks/_libs/react.mjs";
import { p as Route$2, c as useAuthStatus, u as useQuery, a as api, b as useMutation, k as useAction, i as isModerator } from "./router-yCxIimTd.mjs";
import { M as Markdown } from "../_libs/react-markdown.mjs";
import { r as remarkGfm } from "../_libs/remark-gfm.mjs";
import "../_chunks/_libs/@tanstack/router-core.mjs";
import "../_chunks/_libs/@tanstack/history.mjs";
import "../_libs/tiny-invariant.mjs";
import "node:stream/web";
import "node:stream";
import "../_chunks/_libs/@tanstack/react-router.mjs";
import "../_libs/tiny-warning.mjs";
import "../_libs/react-dom.mjs";
import "../_libs/isbot.mjs";
import "../_chunks/_libs/@vercel/analytics.mjs";
import "../_chunks/_libs/@radix-ui/react-dropdown-menu.mjs";
import "../_chunks/_libs/@radix-ui/primitive.mjs";
import "../_chunks/_libs/@radix-ui/react-compose-refs.mjs";
import "../_chunks/_libs/@radix-ui/react-context.mjs";
import "../_chunks/_libs/@radix-ui/react-use-controllable-state.mjs";
import "../_chunks/_libs/@radix-ui/react-use-layout-effect.mjs";
import "../_chunks/_libs/@radix-ui/react-primitive.mjs";
import "../_chunks/_libs/@radix-ui/react-slot.mjs";
import "../_chunks/_libs/@radix-ui/react-menu.mjs";
import "../_chunks/_libs/@radix-ui/react-collection.mjs";
import "../_chunks/_libs/@radix-ui/react-direction.mjs";
import "../_chunks/_libs/@radix-ui/react-dismissable-layer.mjs";
import "../_chunks/_libs/@radix-ui/react-use-callback-ref.mjs";
import "../_chunks/_libs/@radix-ui/react-use-escape-keydown.mjs";
import "../_chunks/_libs/@radix-ui/react-focus-guards.mjs";
import "../_chunks/_libs/@radix-ui/react-focus-scope.mjs";
import "../_chunks/_libs/@radix-ui/react-popper.mjs";
import "../_chunks/_libs/@floating-ui/react-dom.mjs";
import "../_chunks/_libs/@floating-ui/dom.mjs";
import "../_chunks/_libs/@floating-ui/core.mjs";
import "../_chunks/_libs/@floating-ui/utils.mjs";
import "../_chunks/_libs/@radix-ui/react-arrow.mjs";
import "../_chunks/_libs/@radix-ui/react-use-size.mjs";
import "../_chunks/_libs/@radix-ui/react-portal.mjs";
import "../_chunks/_libs/@radix-ui/react-presence.mjs";
import "../_chunks/_libs/@radix-ui/react-roving-focus.mjs";
import "../_chunks/_libs/@radix-ui/react-id.mjs";
import "../_libs/aria-hidden.mjs";
import "../_libs/react-remove-scroll.mjs";
import "../_libs/tslib.mjs";
import "../_libs/react-remove-scroll-bar.mjs";
import "../_libs/react-style-singleton.mjs";
import "../_libs/get-nonce.mjs";
import "../_libs/use-sidecar.mjs";
import "../_libs/use-callback-ref.mjs";
import "../_libs/clsx.mjs";
import "../_libs/tailwind-merge.mjs";
import "../_chunks/_libs/@radix-ui/react-toggle-group.mjs";
import "../_chunks/_libs/@radix-ui/react-toggle.mjs";
import "../_libs/semver.mjs";
import "../_libs/fflate.mjs";
import "module";
import "../_libs/convex-helpers.mjs";
import "../_libs/convex.mjs";
import "../_libs/lucide-react.mjs";
import "../_libs/devlop.mjs";
import "../_libs/unified.mjs";
import "../_libs/bail.mjs";
import "../_libs/extend.mjs";
import "../_libs/is-plain-obj.mjs";
import "../_libs/trough.mjs";
import "../_libs/vfile.mjs";
import "../_libs/vfile-message.mjs";
import "../_libs/unist-util-stringify-position.mjs";
import "node:process";
import "node:path";
import "node:url";
import "../_libs/remark-parse.mjs";
import "../_libs/mdast-util-from-markdown.mjs";
import "../_libs/_CsVBVMCu.mjs";
import "../_libs/micromark-util-decode-string.mjs";
import "../_libs/_vrBDkZ3q.mjs";
import "../_libs/character-entities.mjs";
import "../_libs/_CuJVDrso.mjs";
import "../_libs/micromark.mjs";
import "../_libs/_DLD8nrUX.mjs";
import "../_libs/micromark-util-chunked.mjs";
import "../_libs/micromark-factory-space.mjs";
import "../_libs/micromark-util-character.mjs";
import "../_libs/micromark-core-commonmark.mjs";
import "../_libs/_B_D99lZj.mjs";
import "../_libs/micromark-util-resolve-all.mjs";
import "../_libs/micromark-util-subtokenize.mjs";
import "../_libs/micromark-factory-destination.mjs";
import "../_libs/micromark-factory-label.mjs";
import "../_libs/micromark-factory-title.mjs";
import "../_libs/micromark-factory-whitespace.mjs";
import "../_libs/micromark-util-html-tag-name.mjs";
import "../_libs/mdast-util-to-string.mjs";
import "../_libs/remark-rehype.mjs";
import "../_libs/mdast-util-to-hast.mjs";
import "../_chunks/_libs/@ungap/structured-clone.mjs";
import "../_libs/micromark-util-sanitize-uri.mjs";
import "../_libs/unist-util-position.mjs";
import "../_libs/trim-lines.mjs";
import "../_libs/unist-util-visit.mjs";
import "../_libs/unist-util-visit-parents.mjs";
import "../_libs/unist-util-is.mjs";
import "../_libs/hast-util-to-jsx-runtime.mjs";
import "../_libs/comma-separated-tokens.mjs";
import "../_libs/property-information.mjs";
import "../_libs/space-separated-tokens.mjs";
import "../_libs/style-to-js.mjs";
import "../_libs/style-to-object.mjs";
import "../_libs/inline-style-parser.mjs";
import "../_libs/hast-util-whitespace.mjs";
import "../_libs/estree-util-is-identifier-name.mjs";
import "../_libs/html-url-attributes.mjs";
import "../_libs/micromark-extension-gfm.mjs";
import "../_libs/_BtR1BC-4.mjs";
import "../_libs/_C5wlOzO8.mjs";
import "../_libs/_kK7t0GEl.mjs";
import "../_libs/micromark-extension-gfm-table.mjs";
import "../_libs/_Dcm35_vt.mjs";
import "../_libs/mdast-util-gfm.mjs";
import "../_libs/_CGZt_rLB.mjs";
import "../_libs/ccount.mjs";
import "../_libs/mdast-util-find-and-replace.mjs";
import "../_libs/escape-string-regexp.mjs";
import "../_libs/mdast-util-gfm-footnote.mjs";
import "../_libs/mdast-util-gfm-strikethrough.mjs";
import "../_libs/mdast-util-gfm-table.mjs";
import "../_libs/markdown-table.mjs";
import "../_libs/mdast-util-to-markdown.mjs";
import "../_libs/longest-streak.mjs";
import "../_libs/mdast-util-phrasing.mjs";
import "../_libs/mdast-util-gfm-task-list-item.mjs";
function SoulDetailPage({ slug }) {
  const { isAuthenticated, me } = useAuthStatus();
  const result = useQuery(api.souls.getBySlug, { slug });
  const toggleStar = useMutation(api.soulStars.toggle);
  const addComment = useMutation(api.soulComments.add);
  const removeComment = useMutation(api.soulComments.remove);
  const getReadme = useAction(api.souls.getReadme);
  const ensureSoulSeeds = useAction(api.seed.ensureSoulSeeds);
  const seedEnsuredRef = reactExports.useRef(false);
  const [readme, setReadme] = reactExports.useState(null);
  const [readmeError, setReadmeError] = reactExports.useState(null);
  const [comment, setComment] = reactExports.useState("");
  const isLoadingSoul = result === void 0;
  const soul = result?.soul;
  const owner = result?.owner;
  const latestVersion = result?.latestVersion;
  const versions = useQuery(
    api.souls.listVersions,
    soul ? { soulId: soul._id, limit: 50 } : "skip"
  );
  const isStarred = useQuery(
    api.soulStars.isStarred,
    isAuthenticated && soul ? { soulId: soul._id } : "skip"
  );
  const comments = useQuery(
    api.soulComments.listBySoul,
    soul ? { soulId: soul._id, limit: 50 } : "skip"
  );
  const readmeContent = reactExports.useMemo(() => {
    if (!readme) return null;
    return stripFrontmatter(readme);
  }, [readme]);
  reactExports.useEffect(() => {
    if (seedEnsuredRef.current) return;
    seedEnsuredRef.current = true;
    void ensureSoulSeeds({});
  }, [ensureSoulSeeds]);
  reactExports.useEffect(() => {
    if (!latestVersion) return;
    setReadme(null);
    setReadmeError(null);
    let cancelled = false;
    void getReadme({ versionId: latestVersion._id }).then((data) => {
      if (cancelled) return;
      setReadme(data.text);
    }).catch((error) => {
      if (cancelled) return;
      setReadmeError(error instanceof Error ? error.message : "Failed to load SOUL.md");
      setReadme(null);
    });
    return () => {
      cancelled = true;
    };
  }, [latestVersion, getReadme]);
  if (isLoadingSoul) {
    return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "loading-indicator", children: "Loading soul…" }) }) });
  }
  if (result === null || !soul) {
    return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card", children: "Soul not found." }) });
  }
  const ownerHandle = owner?.handle ?? owner?.name ?? null;
  const downloadBase = `${void 0}/api/v1/souls/${soul.slug}/file`;
  return /* @__PURE__ */ jsxRuntimeExports.jsx("main", { className: "section", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-detail-stack", children: [
    /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card skill-hero", children: /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-header", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-title", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsx("h1", { className: "section-title", style: { margin: 0 }, children: soul.displayName }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", children: soul.summary ?? "No summary provided." }),
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
          "⭐ ",
          soul.stats.stars,
          " · ⤓ ",
          soul.stats.downloads,
          " · ",
          soul.stats.versions,
          " versions"
        ] }),
        ownerHandle ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
          "by ",
          /* @__PURE__ */ jsxRuntimeExports.jsxs("a", { href: `/u/${ownerHandle}`, children: [
            "@",
            ownerHandle
          ] })
        ] }) : null,
        /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-actions", children: isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: `star-toggle${isStarred ? " is-active" : ""}`,
            type: "button",
            onClick: () => void toggleStar({ soulId: soul._id }),
            "aria-label": isStarred ? "Unstar soul" : "Star soul",
            children: /* @__PURE__ */ jsxRuntimeExports.jsx("span", { "aria-hidden": "true", children: "★" })
          }
        ) : null })
      ] }),
      /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-hero-cta", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "skill-version-pill", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsx("span", { className: "skill-version-label", children: "Current version" }),
          /* @__PURE__ */ jsxRuntimeExports.jsxs("strong", { children: [
            "v",
            latestVersion?.version ?? "—"
          ] })
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsx(
          "a",
          {
            className: "btn btn-primary",
            href: `${downloadBase}?path=SOUL.md`,
            "aria-label": "Download SOUL.md",
            children: "Download SOUL.md"
          }
        )
      ] })
    ] }) }),
    /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "card", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "skill-readme markdown", children: readmeContent ? /* @__PURE__ */ jsxRuntimeExports.jsx(Markdown, { remarkPlugins: [remarkGfm], children: readmeContent }) : readmeError ? /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", children: [
      "Failed to load SOUL.md: ",
      readmeError
    ] }) : /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "loading-indicator", children: "Loading SOUL.md…" }) }) }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", marginBottom: 8 }, children: "Versions" }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-scroll", children: /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-list", children: (versions ?? []).map((version) => /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "version-row", children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "version-info", children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
            "v",
            version.version,
            " · ",
            new Date(version.createdAt).toLocaleDateString(),
            version.changelogSource === "auto" ? /* @__PURE__ */ jsxRuntimeExports.jsx("span", { style: { color: "var(--ink-soft)" }, children: " · auto" }) : null
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { color: "#5c554e", whiteSpace: "pre-wrap" }, children: version.changelog })
        ] }),
        /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "version-actions", children: /* @__PURE__ */ jsxRuntimeExports.jsx(
          "a",
          {
            className: "btn version-zip",
            href: `${downloadBase}?path=SOUL.md&version=${encodeURIComponent(
              version.version
            )}`,
            children: "SOUL.md"
          }
        ) })
      ] }, version._id)) }) })
    ] }),
    /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "card", children: [
      /* @__PURE__ */ jsxRuntimeExports.jsx("h2", { className: "section-title", style: { fontSize: "1.2rem", margin: 0 }, children: "Comments" }),
      isAuthenticated ? /* @__PURE__ */ jsxRuntimeExports.jsxs(
        "form",
        {
          onSubmit: (event) => {
            event.preventDefault();
            if (!comment.trim()) return;
            void addComment({ soulId: soul._id, body: comment.trim() }).then(
              () => setComment("")
            );
          },
          className: "comment-form",
          children: [
            /* @__PURE__ */ jsxRuntimeExports.jsx(
              "textarea",
              {
                className: "comment-input",
                rows: 4,
                value: comment,
                onChange: (event) => setComment(event.target.value),
                placeholder: "Leave a note…"
              }
            ),
            /* @__PURE__ */ jsxRuntimeExports.jsx("button", { className: "btn comment-submit", type: "submit", children: "Post comment" })
          ]
        }
      ) : /* @__PURE__ */ jsxRuntimeExports.jsx("p", { className: "section-subtitle", children: "Sign in to comment." }),
      /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { display: "grid", gap: 12, marginTop: 16 }, children: (comments ?? []).length === 0 ? /* @__PURE__ */ jsxRuntimeExports.jsx("div", { className: "stat", children: "No comments yet." }) : (comments ?? []).map((entry) => /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { className: "stat", style: { alignItems: "flex-start" }, children: [
        /* @__PURE__ */ jsxRuntimeExports.jsxs("div", { children: [
          /* @__PURE__ */ jsxRuntimeExports.jsxs("strong", { children: [
            "@",
            entry.user?.handle ?? entry.user?.name ?? "user"
          ] }),
          /* @__PURE__ */ jsxRuntimeExports.jsx("div", { style: { color: "#5c554e" }, children: entry.comment.body })
        ] }),
        isAuthenticated && me && (me._id === entry.comment.userId || isModerator(me)) ? /* @__PURE__ */ jsxRuntimeExports.jsx(
          "button",
          {
            className: "btn",
            type: "button",
            onClick: () => void removeComment({ commentId: entry.comment._id }),
            children: "Delete"
          }
        ) : null
      ] }, entry.comment._id)) })
    ] })
  ] }) });
}
function stripFrontmatter(content) {
  const normalized = content.replace(/\r\n/g, "\n").replace(/\r/g, "\n");
  if (!normalized.startsWith("---")) return content;
  const endIndex = normalized.indexOf("\n---", 3);
  if (endIndex === -1) return content;
  return normalized.slice(endIndex + 4).replace(/^\n+/, "");
}
function SoulDetail() {
  const {
    slug
  } = Route$2.useParams();
  return /* @__PURE__ */ jsxRuntimeExports.jsx(SoulDetailPage, { slug });
}
export {
  SoulDetail as component
};
