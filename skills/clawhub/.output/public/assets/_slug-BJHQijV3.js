import{c as E,u as m,a as l,b as j,l as I,r as i,j as s,i as $,t as M}from"./main-BPgb0gzG.js";import{M as z,r as A}from"./index-Dg9IGsTH.js";function B({slug:a}){const{isAuthenticated:t,me:r}=E(),o=m(l.souls.getBySlug,{slug:a}),U=j(l.soulStars.toggle),_=j(l.soulComments.add),O=j(l.soulComments.remove),N=I(l.souls.getReadme),p=I(l.seed.ensureSoulSeeds),f=i.useRef(!1),[u,h]=i.useState(null),[g,S]=i.useState(null),[x,b]=i.useState(""),R=o===void 0,n=o?.soul,k=o?.owner,c=o?.latestVersion,D=m(l.souls.listVersions,n?{soulId:n._id,limit:50}:"skip"),y=m(l.soulStars.isStarred,t&&n?{soulId:n._id}:"skip"),w=m(l.soulComments.listBySoul,n?{soulId:n._id,limit:50}:"skip"),C=i.useMemo(()=>u?P(u):null,[u]);if(i.useEffect(()=>{f.current||(f.current=!0,p({}))},[p]),i.useEffect(()=>{if(!c)return;h(null),S(null);let e=!1;return N({versionId:c._id}).then(d=>{e||h(d.text)}).catch(d=>{e||(S(d instanceof Error?d.message:"Failed to load SOUL.md"),h(null))}),()=>{e=!0}},[c,N]),R)return s.jsx("main",{className:"section",children:s.jsx("div",{className:"card",children:s.jsx("div",{className:"loading-indicator",children:"Loading soul…"})})});if(o===null||!n)return s.jsx("main",{className:"section",children:s.jsx("div",{className:"card",children:"Soul not found."})});const v=k?.handle??k?.name??null,L=`undefined/api/v1/souls/${n.slug}/file`;return s.jsx("main",{className:"section",children:s.jsxs("div",{className:"skill-detail-stack",children:[s.jsx("div",{className:"card skill-hero",children:s.jsxs("div",{className:"skill-hero-header",children:[s.jsxs("div",{className:"skill-hero-title",children:[s.jsx("h1",{className:"section-title",style:{margin:0},children:n.displayName}),s.jsx("p",{className:"section-subtitle",children:n.summary??"No summary provided."}),s.jsxs("div",{className:"stat",children:["⭐ ",n.stats.stars," · ⤓ ",n.stats.downloads," · ",n.stats.versions," versions"]}),v?s.jsxs("div",{className:"stat",children:["by ",s.jsxs("a",{href:`/u/${v}`,children:["@",v]})]}):null,s.jsx("div",{className:"skill-actions",children:t?s.jsx("button",{className:`star-toggle${y?" is-active":""}`,type:"button",onClick:()=>{U({soulId:n._id})},"aria-label":y?"Unstar soul":"Star soul",children:s.jsx("span",{"aria-hidden":"true",children:"★"})}):null})]}),s.jsxs("div",{className:"skill-hero-cta",children:[s.jsxs("div",{className:"skill-version-pill",children:[s.jsx("span",{className:"skill-version-label",children:"Current version"}),s.jsxs("strong",{children:["v",c?.version??"—"]})]}),s.jsx("a",{className:"btn btn-primary",href:`${L}?path=SOUL.md`,"aria-label":"Download SOUL.md",children:"Download SOUL.md"})]})]})}),s.jsx("div",{className:"card",children:s.jsx("div",{className:"skill-readme markdown",children:C?s.jsx(z,{remarkPlugins:[A],children:C}):g?s.jsxs("div",{className:"stat",children:["Failed to load SOUL.md: ",g]}):s.jsx("div",{className:"loading-indicator",children:"Loading SOUL.md…"})})}),s.jsxs("div",{className:"card",children:[s.jsx("h2",{className:"section-title",style:{fontSize:"1.2rem",marginBottom:8},children:"Versions"}),s.jsx("div",{className:"version-scroll",children:s.jsx("div",{className:"version-list",children:(D??[]).map(e=>s.jsxs("div",{className:"version-row",children:[s.jsxs("div",{className:"version-info",children:[s.jsxs("div",{children:["v",e.version," · ",new Date(e.createdAt).toLocaleDateString(),e.changelogSource==="auto"?s.jsx("span",{style:{color:"var(--ink-soft)"},children:" · auto"}):null]}),s.jsx("div",{style:{color:"#5c554e",whiteSpace:"pre-wrap"},children:e.changelog})]}),s.jsx("div",{className:"version-actions",children:s.jsx("a",{className:"btn version-zip",href:`${L}?path=SOUL.md&version=${encodeURIComponent(e.version)}`,children:"SOUL.md"})})]},e._id))})})]}),s.jsxs("div",{className:"card",children:[s.jsx("h2",{className:"section-title",style:{fontSize:"1.2rem",margin:0},children:"Comments"}),t?s.jsxs("form",{onSubmit:e=>{e.preventDefault(),x.trim()&&_({soulId:n._id,body:x.trim()}).then(()=>b(""))},className:"comment-form",children:[s.jsx("textarea",{className:"comment-input",rows:4,value:x,onChange:e=>b(e.target.value),placeholder:"Leave a note…"}),s.jsx("button",{className:"btn comment-submit",type:"submit",children:"Post comment"})]}):s.jsx("p",{className:"section-subtitle",children:"Sign in to comment."}),s.jsx("div",{style:{display:"grid",gap:12,marginTop:16},children:(w??[]).length===0?s.jsx("div",{className:"stat",children:"No comments yet."}):(w??[]).map(e=>s.jsxs("div",{className:"stat",style:{alignItems:"flex-start"},children:[s.jsxs("div",{children:[s.jsxs("strong",{children:["@",e.user?.handle??e.user?.name??"user"]}),s.jsx("div",{style:{color:"#5c554e"},children:e.comment.body})]}),t&&r&&(r._id===e.comment.userId||$(r))?s.jsx("button",{className:"btn",type:"button",onClick:()=>{O({commentId:e.comment._id})},children:"Delete"}):null]},e.comment._id))})]})]})})}function P(a){const t=a.replace(/\r\n/g,`
`).replace(/\r/g,`
`);if(!t.startsWith("---"))return a;const r=t.indexOf(`
---`,3);return r===-1?a:t.slice(r+4).replace(/^\n+/,"")}function G(){const{slug:a}=M.useParams();return s.jsx(B,{slug:a})}export{G as component};
